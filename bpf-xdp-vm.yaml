# This VM spins up the Ubuntu 22.04 LTS instance and installs required packages
# to build and attach XDP program to a network interface.
#
# You can install Lima on macOS with `brew install lima`.
#
#     $ git clone --recursive-submodules git@github.com:danielpacak/bpf-xdp-go-template.git
#     $ cd bpf-xdp-go-template
#
#     $ limactl start bpf-xdp-vm.yaml
#     $ limactl start --set='.cpus = 4 | .memory = "8GiB"' bpf-xdp-vm.yaml
#
#     $ limactl shell bpf-xdp-vm
#     $ source ./hack/bpf-xdp-vm-init.sh
#
#     $ make
#     $ sudo ./.output/cimon
#
#     $ limactl stop bpf-xdp-vm
#     $ limactl delete bpf-xdp-vm
images:
  - location: "https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-amd64.img"
    arch: "x86_64"
  - location: "https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-arm64.img"
    arch: "aarch64"

cpus: 4
memory: "4GiB"

mounts:
  - location: "~"
    writable: true
  - location: "/tmp/lima"
    writable: true
provision:
  - mode: system
    script: |
      GO_VERSION="1.19.5"
      GO_ARCH=$(uname -m | sed 's/x86_64/amd64/' | sed 's/aarch64/arm64/')
      GO_ARCHIVE=go$GO_VERSION.linux-$GO_ARCH.tar.gz

      sudo apt-get update
      sudo apt-get install --yes bsdutils
      sudo apt-get install --yes build-essential
      sudo apt-get install --yes pkgconf
      sudo apt-get install --yes llvm clang
      sudo apt-get install --yes libelf-dev

      sudo apt-get install --yes linux-tools-$(uname -r)
      sudo apt-get install --yes graphviz

      wget --quiet https://golang.org/dl/$GO_ARCHIVE
      sudo tar -C /usr/local -xzf $GO_ARCHIVE
      rm $GO_ARCHIVE